---

# The default set of tasks for this role which attempts to install, unseal and
# configure a vault cluster.

- name: Install Vault software and systemd service
  import_role:
    name: bbcrd.ansible_vault.install
  tags:
    - ansible_vault_install

- name: Write Vault server configuration files
  import_tasks: subtasks/configure_server.yml
  tags:
    - ansible_vault_configure_server

- name: Perform cluster-wide operations
  # All remaining tasks in this role enact logically cluster-wide operations.
  # Therefore, there is no sense in hobbling on if some node doesn't respond
  # correctly.
  any_errors_fatal: true
  block:
    - name: Initialise first vault node
      import_tasks: subtasks/init_first_node.yml
      tags:
        - ansible_vault_init_first_node
    
    - name: Unseal the cluster (and join new nodes)
      import_tasks: subtasks/unseal.yml
      tags:
        - ansible_vault_unseal
    
    - name: Propagate encrypted unseal keys to new nodes
      import_tasks: subtasks/propagate_unseal_keys.yml
      tags:
        - ansible_vault_propagate_unseal_keys
    
    - name: Remove old nodes from the cluster
      import_tasks: subtasks/remove_old_nodes.yml
      tags:
        - ansible_vault_remove_old_nodes
    
    # NB: This process is deliberately perormed *after* unsealing and pruning
    # the cluster of old nodes since it maximises the chances that the cluster
    # will be in a state where we can safely restart a server without causing
    # an outage.
    - name: Restart vault servers if required
      import_tasks: subtasks/restart.yml
      tags:
        - ansible_vault_restart
    
    
    - name: Rekey unseal keys (e.g. to add/remove admins)
      import_tasks: subtasks/rekey.yml
      tags:
        - ansible_vault_rekey
    
    # TODO: We should probably provide some facility for deploying vault
    # service configuration at this point (e.g. loading up policies and secrets
    # engines etc.)
  
  always:
    - name: Revoke any generated root tokens
      import_tasks: subtasks/revoke_generated_root_token.yml
      tags: always
    
    - name: Clear decrypted unseal keys
      when: unseal_keys_decrypted
      run_once: true
      set_fact:
        ansible_vault_unseal_keys: null
      tags: always
