---

- name: Setup OIDC auth method
  bbcrd.ansible_vault.vault_auth_method:
    type: oidc
    mount: "{{ ansible_vault_oidc_mount }}"
    vault_url: "{{ ansible_vault_public_url }}"
    vault_token: "{{ ansible_vault_root_token }}"
    vault_ca_path: "{{ ansible_vault_ca_path | default(omit) }}"

- name: Configure OIDC auth
  bbcrd.ansible_vault.vault_oidc_configure:
    config:
      oidc_discovery_url: "{{ ansible_vault_oidc_discovery_url }}"
      oidc_discovery_ca_pem: "{{ ansible_vault_oidc_ca_pem | default(omit) }}"
      oidc_client_id: "{{ ansible_vault_oidc_client_id }}"
      oidc_client_secret: "{{ ansible_vault_oidc_client_secret }}"
      default_role: "default"
    mount: "{{ ansible_vault_oidc_mount }}"
    vault_url: "{{ ansible_vault_public_url }}"
    vault_token: "{{ ansible_vault_root_token }}"
    vault_ca_path: "{{ ansible_vault_ca_path | default(omit) }}"

- name: Configure default OIDC role
  bbcrd.ansible_vault.vault_oidc_roles:
    roles:
      default:
        user_claim: "{{ ansible_vault_oidc_user_claim }}"
        token_ttl: "{{ ansible_vault_oidc_token_ttl }}"
        token_max_ttl: "{{ ansible_vault_oidc_token_ttl }}"
        allowed_redirect_uris: "{{ ansible_vault_oidc_redirect_urls }}"
    mount: "{{ ansible_vault_oidc_mount }}"
    vault_url: "{{ ansible_vault_public_url }}"
    vault_token: "{{ ansible_vault_root_token }}"
    vault_ca_path: "{{ ansible_vault_ca_path | default(omit) }}"

- name: Map OIDC end-users to Vault entities
  bbcrd.ansible_vault.vault_auth_method_entity_aliases:
    mount: "{{ ansible_vault_oidc_mount }}"
    entity_aliases: "{{ ansible_vault_oidc_user_claim_to_entity_name_mapping }}"
    vault_url: "{{ ansible_vault_public_url }}"
    vault_token: "{{ ansible_vault_root_token }}"
    vault_ca_path: "{{ ansible_vault_ca_path | default(omit) }}"
