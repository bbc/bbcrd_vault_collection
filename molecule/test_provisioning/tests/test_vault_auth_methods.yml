---

- hosts: vault
  tasks:
    - import_tasks: ../load_credentials_and_reset_vault.yml
    
    - name: Create nothing
      bbcrd.ansible_vault.vault_auth_methods:
        auth_methods: {}
        vault_url: "{{ ansible_vault_public_url }}"
        vault_token: "{{ ansible_vault_root_token }}"
      register: result
      failed_when: result.changed
    
    - name: Create auth methods
      bbcrd.ansible_vault.vault_auth_methods:
        auth_methods:
          my_github:
            type: github
          my_userpass:
            type: userpass
        vault_url: "{{ ansible_vault_public_url }}"
        vault_token: "{{ ansible_vault_root_token }}"
      register: result
      failed_when:  not result.changed
    
    - name: Check created as expected
      uri:
        url: "{{ ansible_vault_public_url }}/v1/sys/auth"
        method: GET
        headers:
          X-Vault-Token: "{{ ansible_vault_root_token }}"
      register: auth_methods
      failed_when: |-
        not (
            "my_github/" in auth_methods.json.data and
            "my_userpass/" in auth_methods.json.data and
            auth_methods.json.data["my_github/"]["type"] == "github" and
            auth_methods.json.data["my_userpass/"]["type"] == "userpass"
        )
    
    - name: No change if left same
      bbcrd.ansible_vault.vault_auth_methods:
        auth_methods:
          my_github:
            type: github
          my_userpass:
            type: userpass
        vault_url: "{{ ansible_vault_public_url }}"
        vault_token: "{{ ansible_vault_root_token }}"
      register: result
      failed_when: result.changed
    
    - name: Delete and recreate when changed
      bbcrd.ansible_vault.vault_auth_methods:
        auth_methods:
          my_github:
            type: github
          my_userpass:
            type: userpass
            description: "Newly added description!"
        vault_url: "{{ ansible_vault_public_url }}"
        vault_token: "{{ ansible_vault_root_token }}"
      register: result
      failed_when: not result.changed
    
    - name: Check change applied
      uri:
        url: "{{ ansible_vault_public_url }}/v1/sys/auth"
        method: GET
        headers:
          X-Vault-Token: "{{ ansible_vault_root_token }}"
      register: auth_methods
      failed_when: |-
        not (
            auth_methods.json.data["my_userpass/"]["description"] == "Newly added description!"
        )
    
    - name: Delete when requested
      bbcrd.ansible_vault.vault_auth_methods:
        auth_methods:
          my_github:
            type: github
          my_userpass: null
        vault_url: "{{ ansible_vault_public_url }}"
        vault_token: "{{ ansible_vault_root_token }}"
      register: result
      failed_when: not result.changed
    
    - name: Check change applied
      uri:
        url: "{{ ansible_vault_public_url }}/v1/sys/auth"
        method: GET
        headers:
          X-Vault-Token: "{{ ansible_vault_root_token }}"
      register: auth_methods
      failed_when: |-
        not (
            "my_github/" in auth_methods.json.data and
            "my_userpass/" not in auth_methods.json.data
        )
