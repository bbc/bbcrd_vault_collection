---

# Generate an ephemeral root token for the vault cluster using unseal keys.
#
# This playbook generates an ephemeral root token and is intended for
# interactive use. Root tokens should only for use in emergencies or unusual
# situations (e.g. any non-automated setup steps).
#
# The generated root token will be revoked when the playbook exits and will in
# any case have a lifetime limited by ansible_vault_root_token_ttl.

- name: Generate an ephemeral root token
  hosts: "{{ ansible_vault_cluster_ansible_group_name | default('vault') }}"
  become: "{{ ansible_vault_become | default(True) }}"

  tasks:
    - block:
        - name: Create ephemeral GnuPG environment for handling unseal keys
          import_role:
            name: bbcrd.ansible_vault.ephemeral_gnupg_home
          tags:
            - always
            - ansible_vault_ephemeral_gnupg_home
            # The molecule test suite uses its own GnuPG environment with its
            # own test keypairs.
            - molecule-notest

        - name: Obtain root token
          import_role:
            name: bbcrd.ansible_vault.generate_root

        - name: Run `vault login` on Ansible control node
          delegate_to: localhost
          become: false
          run_once: true
          tags: ansible_vault_login
          command:
            argv:
              - "{{ ansible_vault_binary | default('vault') }}"
              - login
              - "-"
            stdin: "{{ ansible_vault_root_token }}"
          environment:
            VAULT_ADDR: "{{ ansible_vault_public_url }}"
            VAULT_CACERT: "{{ ansible_vault_ca_path | default(omit) }}"
          register: vault_login
        
        - name: Display vault login response
          run_once: true
          tags: ansible_vault_login
          debug:
            msg: "{{ vault_login.stdout_lines }}"

        - name: Wait for user to confirm finished with root token
          run_once: true
          pause:
            prompt: "Press enter to revoke root token {{ ansible_vault_root_token }}"

      always:
        - name: Revoke root token
          import_role:
            name: bbcrd.ansible_vault.generate_root
            tasks_from: revoke.yml

        - name: Clean up ephemeral GnuPG environment
          import_role:
            name: bbcrd.ansible_vault.ephemeral_gnupg_home
            tasks_from: cleanup.yml
          tags:
            - always
            - ansible_vault_ephemeral_gnupg_home
